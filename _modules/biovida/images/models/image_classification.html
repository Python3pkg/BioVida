<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>biovida.images.models.image_classification &#8212; BioVida 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/bootswatch-3.3.6/simplex/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          BioVida</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/TariqAHassan/BioVida">View on GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../GettingStarted.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../GettingStarted.html#dependencies">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../GettingStarted.html#image-data">Image Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../GettingStarted.html#cancer-imaging-archive">Cancer Imaging Archive</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../GettingStarted.html#open-i-biomedical-image-search-engine">Open-i BioMedical Image Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../GettingStarted.html#automated-image-data-cleaning">Automated Image Data Cleaning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../GettingStarted.html#genomic-data">Genomic Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../GettingStarted.html#data-harvesting">Data Harvesting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../GettingStarted.html#exploring-available-databases">Exploring Available Databases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../GettingStarted.html#diagnostic-data">Diagnostic Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../GettingStarted.html#id1">Data Harvesting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../API.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../API.html#module-biovida.images.openi_interface">Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#open-i-interface">Open-i Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#cancer-imaging-archive-interface">Cancer Imaging Archive Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#image-processing">Image Processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#image-classification">Image Classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#template-matching">Template Matching</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#border-and-edge-detection">Border and Edge Detection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../API.html#module-biovida.genomics.disgenet_interface">Genomics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#disgenet-interface">DisGeNET Interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../API.html#module-biovida.diagnostics.disease_ont_interface">Diagnostics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#disease-ontology-interface">Disease Ontology Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#disease-symptoms-interface">Disease-Symptoms Interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../API.html#module-biovida.unification.unify_domains">Domain Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#unifying-across-domains">Unifying Across Domains</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../API.html#module-biovida.images.image_cache_mgmt">Cache Manipulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#image-cache-management">Image Cache Management</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../API.html#module-biovida.support_tools.utilities">Support Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#utilities">Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../API.html#printing-tools">Printing Tools</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Current Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
        </div>
      </div>
    <div class="col-md-9 content">
      
  <h1>Source code for biovida.images.models.image_classification</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Image Classification</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Resources Used:</span>
<span class="c1">#    - https://blog.keras.io/building-powerful-image-classification-models-using-very-little-data.html</span>
<span class="c1">#    - https://blog.rescale.com/neural-networks-using-keras-on-rescale/</span>
<span class="c1">#    - http://cs231n.github.io</span>

<span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">biovida.images._image_tools</span> <span class="k">import</span> <span class="n">load_and_scale_images</span>

<span class="kn">from</span> <span class="nn">keras</span> <span class="k">import</span> <span class="n">callbacks</span>
<span class="kn">from</span> <span class="nn">keras.preprocessing.image</span> <span class="k">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">load_model</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="k">import</span> <span class="n">Convolution2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">ZeroPadding2D</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="k">import</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">merge</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="k">import</span> <span class="n">RMSprop</span><span class="p">,</span> <span class="n">SGD</span>


<span class="c1"># Problem: ValueError: Negative dimension size caused by subtracting 2 from 1</span>
<span class="c1"># Solution: replace &quot;tf&quot; with &quot;th&quot; in ~/.keras/keras.json.</span>
<span class="c1"># Note: `MaxPooling2D` has a `dim_ordering` param which can do the same thing.</span>

<span class="c1"># ToDo: it&#39;s not currently obvious if keras.preprocessing.ImageDataGenerator().flow_from_directory()</span>
<span class="c1"># performs the preprocessing described in https://arxiv.org/pdf/1409.1556.pdf</span>


<div class="viewcode-block" id="ImageClassificationCNN"><a class="viewcode-back" href="../../../../other/images.html#biovida.images.models.image_classification.ImageClassificationCNN">[docs]</a><span class="k">class</span> <span class="nc">ImageClassificationCNN</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Keras Convolutional Neural Networks Interface.</span>

<span class="sd">    :param data_path: path to the directory with the subdirectories entitled &#39;train&#39; and &#39;validation&#39;.</span>
<span class="sd">                      This directory *must* have this structure. Defaults to ``None`` (to be use when loading</span>
<span class="sd">                      pre-computed weights).</span>
<span class="sd">    :type data_path: ``str``</span>
<span class="sd">    :param image_shape: the (height, width) to rescale the images to. Elements must be ``ints``. Defaults to ``(150, 150)``.</span>
<span class="sd">    :type image_shape: ``tuple`` or ``list``.</span>
<span class="sd">    :param rescale: See: ``keras.preprocessing.image.ImageDataGenerator()``. Defaults to 1/255.</span>
<span class="sd">    :type rescale: ``float``</span>
<span class="sd">    :param shear_range: See: ``keras.preprocessing.image.ImageDataGenerator()``. Defaults to 0.1.</span>
<span class="sd">    :type shear_range: ``float``</span>
<span class="sd">    :param zoom_range: See: ``keras.preprocessing.image.ImageDataGenerator()``. Defaults to 0.35.</span>
<span class="sd">    :type zoom_range: ``float``</span>
<span class="sd">    :param horizontal_flip: See: ``keras.preprocessing.image.ImageDataGenerator()``. Defaults to ``True``.</span>
<span class="sd">    :type horizontal_flip: ``bool``</span>
<span class="sd">    :param vertical_flip: See: ``keras.preprocessing.image.ImageDataGenerator()``. Defaults to ``True``.</span>
<span class="sd">    :type vertical_flip: ``bool``</span>
<span class="sd">    :param batch_size: Samples to propagate through the model.</span>
<span class="sd">                       See: ``keras.preprocessing.ImageDataGenerator().flow_from_directory()``.</span>
<span class="sd">                       Defaults to 4.</span>
<span class="sd">    :type batch_size: ``int``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">image_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
                 <span class="n">rescale</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span>
                 <span class="n">shear_range</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                 <span class="n">zoom_range</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span>
                 <span class="n">horizontal_flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">vertical_flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">image_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span> <span class="o">=</span> <span class="n">rescale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shear_range</span> <span class="o">=</span> <span class="n">shear_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_range</span> <span class="o">=</span> <span class="n">zoom_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_horizontal_flip</span> <span class="o">=</span> <span class="n">horizontal_flip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vertical_flip</span> <span class="o">=</span> <span class="n">vertical_flip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>

        <span class="c1"># Define data location</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validation_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">)</span>

        <span class="c1"># Data Streams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_generator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_generator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The model itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_classes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_train_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Use of ``keras.preprocessing.image.ImageDataGenerator()`` to generate training stream.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Train augmentation configuration</span>
        <span class="n">train_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rescale</span>
                                           <span class="p">,</span> <span class="n">shear_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shear_range</span>
                                           <span class="p">,</span> <span class="n">zoom_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_zoom_range</span>
                                           <span class="p">,</span> <span class="n">vertical_flip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vertical_flip</span>
                                           <span class="p">,</span> <span class="n">horizontal_flip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_horizontal_flip</span><span class="p">)</span>

        <span class="c1"># Indefinitely generate batches of augmented train image data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_generator</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_data_dir</span><span class="p">,</span>
                                                                  <span class="n">target_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span>
                                                                  <span class="n">class_mode</span><span class="o">=</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                                                                  <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_val_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Use of ``keras.preprocessing.image.ImageDataGenerator()`` to generate validation stream.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Test augmentation configuration</span>
        <span class="n">validation_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">)</span>

        <span class="c1"># This is a similar generator, for validation data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_generator</span> <span class="o">=</span> <span class="n">validation_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_validation_data_dir</span><span class="p">,</span>
                                                                            <span class="n">target_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span>
                                                                            <span class="n">class_mode</span><span class="o">=</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                                                                            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_data_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Generate Data Streams using ``keras.preprocessing.ImageDataGenerator()``.</span>

<span class="sd">        :raises: ``ValueError`` if there are asymmetries between the &#39;train&#39; and &#39;validation&#39;</span>
<span class="sd">                 subdirectories in ``self._data_path``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create Data Streams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_gen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_val_gen</span><span class="p">()</span>

        <span class="c1"># Update</span>
        <span class="n">train_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_generator</span><span class="o">.</span><span class="n">class_indices</span>
        <span class="n">val_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_generator</span><span class="o">.</span><span class="n">class_indices</span>

        <span class="k">def</span> <span class="nf">set_diff</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Returns `True` if there are things in b not in a, else `False`.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Check for a mismatch of folders between &#39;train&#39; and &#39;validation&#39;.</span>
        <span class="n">chk</span> <span class="o">=</span> <span class="p">[(</span><span class="n">train_classes</span><span class="p">,</span> <span class="n">val_classes</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">val_classes</span><span class="p">,</span> <span class="n">train_classes</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="n">chk</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">set_diff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the `</span><span class="si">{0}</span><span class="s2">` folder is missing the following&quot;</span>
                                 <span class="s2">&quot; folders found in &#39;</span><span class="si">{1}</span><span class="s2">&#39;: </span><span class="si">{2}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span><span class="p">)))))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_classes</span> <span class="o">=</span> <span class="n">train_classes</span>

    <span class="k">def</span> <span class="nf">_impose_vgg_image_reqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        This method imposes the 224x224 image size requirement made by VGG 19.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">224</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is an invalid image height for vgg_19. Falling back 224.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">224</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">224</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is an invalid image width for vgg_19. Falling back to 224.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">224</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_alex_net</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_classes</span><span class="p">,</span> <span class="n">output_layer_activation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Sources:</span>
<span class="sd">        -------</span>
<span class="sd">        1. https://papers.nips.cc/paper/4824-imagenet-classification-with-deep-convolutional-neural-networks.pdf</span>

<span class="sd">        2. https://github.com/heuritech/convnets-keras/blob/master/convnetskeras/convnets.py</span>

<span class="sd">        Copyright (c) 2016 Heuritech</span>

<span class="sd">        Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated</span>
<span class="sd">        documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation</span>
<span class="sd">        the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="sd">        and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>

<span class="sd">        The above copyright notice and this permission notice shall be included in all copies or substantial portions</span>
<span class="sd">        of the Software.</span>

<span class="sd">        THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED</span>
<span class="sd">        TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL</span>
<span class="sd">        THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF</span>
<span class="sd">        CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="sd">        DEALINGS IN THE SOFTWARE.</span>

<span class="sd">        :param nb_classes: number of neuron in the output layer (which equals the number of classes).</span>
<span class="sd">        :type nb_classes: ``int``</span>
<span class="sd">        :param output_layer_activation: the activation function to use on the output layer. See: https://keras.io/activations/#available-activations. Defaults to &#39;sigmoid&#39;.</span>
<span class="sd">        :type output_layer_activation: ``str``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">convnetskeras.customlayers</span> <span class="k">import</span> <span class="n">crosschannelnormalization</span><span class="p">,</span> <span class="n">splittensor</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;This method requires the &#39;convnets-keras&#39; library.</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;This library can be installed by running the following command from the command line:</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;$ pip install git+git://github.com/heuritech/convnets-keras@master&quot;</span><span class="p">)</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">conv_1</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>
                               <span class="n">subsample</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                               <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_1&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>

        <span class="n">conv_2</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">conv_1</span><span class="p">)</span>
        <span class="n">conv_2</span> <span class="o">=</span> <span class="n">crosschannelnormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;convpool_1&quot;</span><span class="p">)(</span><span class="n">conv_2</span><span class="p">)</span>
        <span class="n">conv_2</span> <span class="o">=</span> <span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">conv_2</span><span class="p">)</span>
        <span class="n">conv_2</span> <span class="o">=</span> <span class="n">merge</span><span class="p">([</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_2_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))(</span>
                               <span class="n">splittensor</span><span class="p">(</span><span class="n">ratio_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">id_split</span><span class="o">=</span><span class="n">i</span><span class="p">)(</span><span class="n">conv_2</span><span class="p">)</span>
                           <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="n">concat_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_2&quot;</span><span class="p">)</span>

        <span class="n">conv_3</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">conv_2</span><span class="p">)</span>
        <span class="n">conv_3</span> <span class="o">=</span> <span class="n">crosschannelnormalization</span><span class="p">()(</span><span class="n">conv_3</span><span class="p">)</span>
        <span class="n">conv_3</span> <span class="o">=</span> <span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="n">conv_3</span><span class="p">)</span>
        <span class="n">conv_3</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_3&#39;</span><span class="p">)(</span><span class="n">conv_3</span><span class="p">)</span>

        <span class="n">conv_4</span> <span class="o">=</span> <span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="n">conv_3</span><span class="p">)</span>
        <span class="n">conv_4</span> <span class="o">=</span> <span class="n">merge</span><span class="p">([</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_4_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))(</span>
                               <span class="n">splittensor</span><span class="p">(</span><span class="n">ratio_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">id_split</span><span class="o">=</span><span class="n">i</span><span class="p">)(</span><span class="n">conv_4</span><span class="p">)</span>
                           <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="n">concat_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_4&quot;</span><span class="p">)</span>

        <span class="n">conv_5</span> <span class="o">=</span> <span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="n">conv_4</span><span class="p">)</span>
        <span class="n">conv_5</span> <span class="o">=</span> <span class="n">merge</span><span class="p">([</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_5_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))(</span>
                               <span class="n">splittensor</span><span class="p">(</span><span class="n">ratio_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">id_split</span><span class="o">=</span><span class="n">i</span><span class="p">)(</span><span class="n">conv_5</span><span class="p">)</span>
                           <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="n">concat_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_5&quot;</span><span class="p">)</span>
        <span class="n">dense_1</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;convpool_5&quot;</span><span class="p">)(</span><span class="n">conv_5</span><span class="p">)</span>

        <span class="n">dense_1</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;flatten&quot;</span><span class="p">)(</span><span class="n">dense_1</span><span class="p">)</span>
        <span class="n">dense_1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_1&#39;</span><span class="p">)(</span><span class="n">dense_1</span><span class="p">)</span>
        <span class="n">dense_2</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">dense_1</span><span class="p">)</span>
        <span class="n">dense_2</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_2&#39;</span><span class="p">)(</span><span class="n">dense_2</span><span class="p">)</span>
        <span class="n">dense_3</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">dense_2</span><span class="p">)</span>
        <span class="n">dense_3</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_3&#39;</span><span class="p">)(</span><span class="n">dense_3</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="n">output_layer_activation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">output_layer_activation</span><span class="p">)(</span><span class="n">dense_3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">prediction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_vgg_19</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_classes</span><span class="p">,</span> <span class="n">output_layer_activation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Keras Implementation of the VGG_19 Model</span>

<span class="sd">        SOURCES:</span>
<span class="sd">        -------</span>

<span class="sd">        1. Model Authors:</span>
<span class="sd">           Very Deep Convolutional Networks for Large-Scale Image Recognition</span>
<span class="sd">           K. Simonyan, A. Zisserman</span>
<span class="sd">           arXiv:1409.1556</span>

<span class="sd">        2. Keras Implementation: https://gist.github.com/baraldilorenzo/8d096f48a1be4a2d660d#file-vgg-19_keras-py</span>

<span class="sd">        :param nb_classes: number of neuron in the output layer (which equals the number of classes).</span>
<span class="sd">        :type nb_classes: ``int``</span>
<span class="sd">        :param output_layer_activation: the activation function to use on the output layer. See: https://keras.io/activations/#available-activations. Defaults to &#39;sigmoid&#39;.</span>
<span class="sd">        :type output_layer_activation: ``str``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ZeroPadding2D</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">output_layer_activation</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_default_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_classes</span><span class="p">,</span> <span class="n">output_layer_activation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        The most simple model in this class.</span>

<span class="sd">        :param nb_classes: number of neuron in the output layer (which equals the number of classes).</span>
<span class="sd">        :type nb_classes: ``int``</span>
<span class="sd">        :param output_layer_activation: the activation function to use on the output layer. See: https://keras.io/activations/#available-activations. Defaults to &#39;sigmoid&#39;.</span>
<span class="sd">        :type output_layer_activation: ``str``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
                                     <span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                     <span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Convolution2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="n">output_layer_activation</span><span class="p">))</span>

<div class="viewcode-block" id="ImageClassificationCNN.convnet"><a class="viewcode-back" href="../../../../other/images.html#biovida.images.models.image_classification.ImageClassificationCNN.convnet">[docs]</a>    <span class="k">def</span> <span class="nf">convnet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">model_to_use</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,),</span>
                <span class="n">output_layer_activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Define and Compile the Image Recognition Convolutional Neural Network.</span>

<span class="sd">        :param model_to_use: one of: &#39;default&#39;, &#39;vgg19&#39;, &#39;alex_net&#39;. Defaults to &#39;default&#39;.</span>

<span class="sd">            - &#39;default&#39;: a relatively simple sequential model with two convolution layers (each followed by 2x2 max pooling); one hidden layer and 0.5 drop out.</span>

<span class="sd">            - &#39;alex_net&#39;: the 2012 &#39;AlexNet&#39; model.</span>

<span class="sd">            - &#39;vgg19&#39;: the VGG 19 model.</span>

<span class="sd">        :type model_to_use: ``str``</span>
<span class="sd">        :param loss: Loss function. Defaults to &#39;categorical_crossentropy&#39;.</span>
<span class="sd">                     See: ``keras.models.Sequential()``.</span>
<span class="sd">        :type loss: ``str``</span>
<span class="sd">        :param optimizer: Optimizer name. Defaults to &#39;default&#39;, which will use RMSprop with learning rate = ``0.0001``.</span>
<span class="sd">                          See: ``keras.models.Sequential()``.</span>
<span class="sd">        :type optimizer: ``str`` or ``keras.optimizers``</span>
<span class="sd">        :param metrics: Metrics to evaluate. Defaults to (&#39;accuracy&#39;,).</span>
<span class="sd">                        Note: if round braces are used, it MUST contain a comma (to make it a tuple).</span>
<span class="sd">                        See: ``keras.models.Sequential()``.</span>
<span class="sd">        :type metrics: ``tuple``</span>
<span class="sd">        :param output_layer_activation: the activation function to use on the output layer. See: https://keras.io/activations/#available-activations. Defaults to &#39;sigmoid&#39;.</span>
<span class="sd">        :type output_layer_activation: ``str``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_to_use</span> <span class="o">==</span> <span class="s1">&#39;vgg19&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_impose_vgg_image_reqs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_stream</span><span class="p">()</span>

        <span class="c1"># Get the number of classes</span>
        <span class="n">nb_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_classes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Define the Model</span>
        <span class="k">if</span> <span class="n">model_to_use</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_model</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">output_layer_activation</span><span class="o">=</span><span class="n">output_layer_activation</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model_to_use</span> <span class="o">==</span> <span class="s1">&#39;alex_net&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alex_net</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">output_layer_activation</span><span class="o">=</span><span class="n">output_layer_activation</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model_to_use</span> <span class="o">==</span> <span class="s1">&#39;vgg19&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vgg_19</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">output_layer_activation</span><span class="o">=</span><span class="n">output_layer_activation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39; is an invalid value for `model_to_use`.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_to_use</span><span class="p">))</span>

        <span class="c1"># Define optimizer</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">optimizer_to_pass</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;vgg19&#39;</span><span class="p">:</span>
            <span class="n">optimizer_to_pass</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">nesterov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimizer_to_pass</span> <span class="o">=</span> <span class="n">optimizer</span>

        <span class="c1"># Compilation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer_to_pass</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_model_existence_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_format</span><span class="p">,</span> <span class="n">second_format</span><span class="p">,</span> <span class="n">additional</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Raises appropriate AttributeError based on content in which an undefined model was encountered.</span>

<span class="sd">        :param first_format: action the model</span>
<span class="sd">        :type first_format: ``str``</span>
<span class="sd">        :param second_format: name of an ``ImageClassificationCNN`` method.</span>
<span class="sd">        :type second_format: ``str``</span>
<span class="sd">        :raises: ``AttributeError`` composed from `first_format` and `second_format`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The model cannot be </span><span class="si">{0}</span><span class="s2"> until `ImageClassificationCNN().</span><span class="si">{1}</span><span class="s2">()` &quot;</span>
                                 <span class="s2">&quot;has been called.</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">first_format</span><span class="p">,</span> <span class="n">second_format</span><span class="p">,</span> <span class="n">additional</span><span class="p">))</span>

<div class="viewcode-block" id="ImageClassificationCNN.fit"><a class="viewcode-back" href="../../../../other/images.html#biovida.images.models.image_classification.ImageClassificationCNN.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Fit the model to the training data and run a validation.</span>

<span class="sd">        :param nb_epoch: number of epochs. See: ``keras.models.Sequential()``. Defaults to 10.</span>
<span class="sd">        :type nb_epoch: ``int``</span>
<span class="sd">        :param min_delta: see ``keras.callbacks.EarlyStopping()``.</span>
<span class="sd">        :type min_delta: ``float``</span>
<span class="sd">        :param patience: see ``keras.callbacks.EarlyStopping()``.</span>
<span class="sd">        :type patience: ``int``</span>
<span class="sd">        :raises: ``AttributeError`` if ``ImageClassificationCNN().convnet()`` is yet to be called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_existence_check</span><span class="p">(</span><span class="s2">&quot;fit and validated&quot;</span><span class="p">,</span> <span class="s2">&quot;convnet&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nb_epoch</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`nb_epoch` must be an integer.&quot;</span><span class="p">)</span>

        <span class="c1"># Define callbacks</span>
        <span class="n">early_stop</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="n">min_delta</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="n">patience</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_generator</span><span class="p">,</span>
                                 <span class="n">samples_per_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_generator</span><span class="o">.</span><span class="n">nb_sample</span><span class="p">,</span>
                                 <span class="n">nb_epoch</span><span class="o">=</span><span class="n">nb_epoch</span><span class="p">,</span>
                                 <span class="n">validation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_validation_generator</span><span class="p">,</span>
                                 <span class="n">nb_val_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_validation_generator</span><span class="o">.</span><span class="n">nb_sample</span><span class="p">,</span>
                                 <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_support_save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_name</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Supporting Data For the Model.</span>

<span class="sd">        :param save_name: see ``save()``</span>
<span class="sd">        :type save_name: ``str``</span>
<span class="sd">        :param save_path: see ``save()``</span>
<span class="sd">        :type save_path: ``str``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shear_range</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_range</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_horizontal_flip</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_classes</span><span class="p">]</span>

        <span class="c1"># Pickle the `data` dictionary.</span>
        <span class="n">save_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_support.p&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_name</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_location</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="ImageClassificationCNN.save"><a class="viewcode-back" href="../../../../other/images.html#biovida.images.models.image_classification.ImageClassificationCNN.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Save the weights from a trained model.</span>

<span class="sd">        :param save_name: name of the file. Do not include the &#39;.h5&#39; extension as it</span>
<span class="sd">                     will be added automatically.</span>
<span class="sd">        :type save_name: ``str``</span>
<span class="sd">        :param path: path to save the data to. See: ``keras.models.Sequential()``.</span>
<span class="sd">        :type path: ``str``</span>
<span class="sd">        :param overwrite: overwrite the existing copy of the data</span>
<span class="sd">        :type overwrite: ``bool``</span>
<span class="sd">        :raises: ``AttributeError`` if ``ImageClassificationCNN().fit()`` is yet to be called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_existence_check</span><span class="p">(</span><span class="s2">&quot;saved&quot;</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">,</span>  <span class="s2">&quot; Alternatively, you can call .load().&quot;</span><span class="p">)</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">path</span>

        <span class="c1"># Save the supporting data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_support_save_data</span><span class="p">(</span><span class="n">save_name</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>

        <span class="c1"># Save the Model itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_name</span><span class="p">)),</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_support_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Loads supporting data saved along with the model</span>

<span class="sd">        :param path: see ``load()``.</span>
<span class="sd">        :type path: ``str``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">load_location</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_support.p&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">load_location</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shear_range</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_range</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_horizontal_flip</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_classes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>

<div class="viewcode-block" id="ImageClassificationCNN.load"><a class="viewcode-back" href="../../../../other/images.html#biovida.images.models.image_classification.ImageClassificationCNN.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">override_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_model_load</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Load a model from disk.</span>

<span class="sd">        :param path: path to save the data to.See: ``keras.models.Sequential()``.</span>
<span class="sd">        :type path: ``str``</span>
<span class="sd">        :param override_existing: If True and a model has already been instantiated, override this replace this model.</span>
<span class="sd">                                  Defaults to ``False``.</span>
<span class="sd">        :type override_existing: ``bool``</span>
<span class="sd">        :param default_model_load: load the default model if ``ImageClassificationCNN().convnet()`` has not been called.</span>
<span class="sd">                                   Defaults to ``False``.</span>
<span class="sd">        :type default_model_load: ``bool``</span>
<span class="sd">        :raises: ``AttributeError`` if a model is currently instantiated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">override_existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;A model is currently instantiated.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;Set `override_existing` to `True` to replace the existing model.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">default_model_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convnet</span><span class="p">()</span>

        <span class="c1"># Load the supporting data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_support_load_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Load the Model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_prediction_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">single_image_prediction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Convert a single prediction into a human-readable list of tuples.</span>

<span class="sd">        :param single_image_prediction: see ``predict()``</span>
<span class="sd">        :type single_image_prediction: list of ndarray arrays.</span>
<span class="sd">        :return: a list of tuples where the elements are of the form ``(label, P(label))``</span>
<span class="sd">        :rtype: ``list``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_classes_reversed</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_classes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">((</span><span class="n">data_classes_reversed</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">single_image_prediction</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="ImageClassificationCNN.predict"><a class="viewcode-back" href="../../../../other/images.html#biovida.images.models.image_classification.ImageClassificationCNN.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_images</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Generate Predictions for a list of images.</span>

<span class="sd">        :param list_of_images: a list of paths (strings) to images or ``ndarrays``.</span>
<span class="sd">        :type list_of_images: ``list``</span>
<span class="sd">        :param status: True for a tqdm status bar; False for no status bar. Defaults to True.</span>
<span class="sd">        :type status: ``bool``</span>
<span class="sd">        :param verbose: if True, print updates. Defaults to False</span>
<span class="sd">        :type verbose: ``bool``</span>
<span class="sd">        :return: a list of lists with tuples of the form (name, probability). Defaults to False.</span>
<span class="sd">        :rtype: ``list``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Predictions cannot be made until a model is loaded or trained.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">status_bar</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># ToDo: Not working properly (see: https://github.com/bstriner/keras-tqdm)</span>
            <span class="k">return</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">status</span> <span class="k">else</span> <span class="n">x</span>

        <span class="n">number_ndarray</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ndarray&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_of_images</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">number_ndarray</span><span class="p">):</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">list_of_images</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">number_ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only some of the items in `list_of_images` we found to be `ndarrays`.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Preparing Images for Neural Network...&quot;</span><span class="p">)</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">load_and_scale_images</span><span class="p">(</span><span class="n">list_of_images</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">grayscale_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Generating Predictions...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_prediction_labels</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">status_bar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">images</span><span class="p">))]</span></div></div>








































</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, Tariq A. Hassan.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>